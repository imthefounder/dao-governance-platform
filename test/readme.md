# Test Cases

We conducted the following categories of tests to ensure the correctness and robustness of the smart contracts we have developed:

1. Unit tests
2. Integration tests
3. Fuzz tests

We will list up all the test cases we have set up for these categories here.

We've tried our best to cover all the test cases and the test coverage is 100% for each contract we have developed.

The evidence is the coverage report generated by `forge coverage`.

Terms:

- Special cases: test cases which are mostly customized functions
- Normal cases: test cases which are mostly normal ERC standard functions

## Unit Tests

### AmbassadorNft.t.sol

This is the NFT contract for the ambassador program.

- setUp
  - deploy contract and mint some tokens for users

ERC1155 special test cases

- testTokenRoles
- testConstructorWillRevertIfAdminIsZero
- testMintingTokensSuccessfully
- testMintingTokenWillFailByNonMinter
- testMintingTokenWillSucceedByNewMinter
- testBurningTokenSuccessfully
- testBurningTokenWillFailByNonBurner
- testBurningTokenWillSucceedByNewBurner
- testBurnBatchCanBeCalledByBurner
- testBurnBatchWillFailByNonBurner

ERC1155 normal test cases

- testSetURI
- testSetURIByNonUriSetter
- testBalanceOfWorks
- testBalanceOfBatchWorks
- testTransferWillWork
- testMintBatchWillWork
- testSupportsInterface

### ERC20UpgradeableTokenV1.t.sol

This is the utility token contract.

- setUp
- testSucceedingToBurnTokens
- testFailingToBurnTokens
- testShowingBasicTokenInfo
- testRolesAreSetCorrectly
- testPausingAndUnpausing
- testGrantRoles
- testGrantingAndRevokingRoles
- testApprovingSpending
- testApprovingAndTransferFrom
- testApprovingAllAndTransferFromAll
- testApprovingAllAndTransferFromHalf
- testSendingTokens
- testUpgradeabilityOfToken

### VotingPowerExchange.t.sol

- setUp
- testSpecialCasesForCalculateVotingPowerFromBurnedAmount
- testSomeMoreSpecialCasesForCalculateVotingPowerFromBurnedAmount
- testCalculateVotingPowerFromBurnedAmount
- testCalculateVotingPowerFromBurnedAmountRareCases
- testCalculationOfVotingPowerMintingWhenMintedSeparately
- testCalculationOfVotingPowerMintingWhenMintedSeparately2
- testCalculateIncrementedVotingPower
- testCalculateBurningAmountFromVotingPower
- testCalculateIncrementedBurningAmount

### GovToken.t.sol

This is the token contract for the governance system.

- setUp
- testGovTokenDefaultAdminCannotBeZero
- testClockMode
- testTokensAreNotTransferrable
- testMintingCanBeDoneByMinter
- testMintingCannotBeDoneByNonMinter
- testMintingCanBeDoneByNewMinter
- testBurningCanBeDoneByBurner
- testBurningCannotBeDoneByNonBurner
- testBurningCanBeDoneByNewBurner
- testVotingPowerExchangeCanCallSetBurnedAmountOfUtilToken
- testNonRoleCannotCallSetBurnedAmountOfUtilToken
- testSetBurnedAmountOfUtilTokenEvent
- testTheRolesOfTheGovToken
- testTheTokenInfos
- testNonces
- testDelegateBySig
- testClock

## Integration Tests

### VotingPowerExchange.t.sol

This contract is the main contract of this system, so it is tested most heavily this time.

Some basic tests

- setUp
- testReturnedSetupValues
- testTokensAccessRoles
- testVotingPowerExchangesRoles
- testUtilityTokenBasicInfo
- testGovTokenBasicInfo
- testGovTokenNotBeingTransferrable
- testUtilityTokenCanBeTransferred
- testTokensBalanceOf
- testTokensBurning
- testUtilityTokensPausability

Core tests for VotingPowerExchange

- testConstructorOfVotingPowerExchange
- testBasicVotingPowerExchangeInfo
- testConstantValues
- testVotingPowerCap
- testSettingVotingPowerCap
- testSettingVotingPowerCapFails
- testSettingVotingPowerCapFailsCase2
- testCalculationOfIncreasedVotingPowerWhenCurrentIsZero
- testCalculationOfIncreasedVotingPowerWhenCurrentIsNotZero
- testCalculateIncrementedBurningAmountWhenCurrentIsZero
- testCalculateIncrementedBurningAmountWhenCurrentIsNotZero

Exchange tests

- testExchangeMediumAmountSuccessCase
- testExchangeSmallAmountSuccessCase
- testExchangeLargeAmountSuccessCase
- testExchangeVotingPowerCapSuccessCase
- testExchangeTwiceToGetToVotingPowerCapSuccessCase
- testExchangeTwiceToCrossVotingPowerCapFailureCase
- testExchangeFailsWhenSenderIsZeroAddress
- testExchangeFailsWhenAmountIsZero
- testExchangeFailCaseWhenAmountIsTooSmall
- testExchangeFailCaseWhenNonceIsUsed
- testExchangeFailCaseWhenSignatureExpired
- testExchangeFailCaseWhenSenderIsNotSigner
- testExchangeFailCaseWhenSignatureIsInvalid
- testExchangeFailCaseWhenUserGotMoreThanVotingPowerCap

Preparation internal functions

- createDigest
- checkExchangeResult

## Fuzz Tests

- setUp

exchange function

- testExchangeWithAnySenderWhoIsNotTheSignerWillRevert
- testExchangeWithAnyAmountLessThan1e18WillRevert
- testExchangeWithAnyAmountWhichIsInRangeWillSucceed
- testExchangeWithAnyAmountWithinNewCapWillSucceed
- testExchangeWithAnyRoleWhoIsNotExchangerWillRevert
- testExchangeWithAnyNonceWhichIsUsedWillRevert
- testExchangeWithAnyExpirationWhichIsExpiredWillRevert
- testExchangeWithAnyExpirationWhichIsNotExpiredWillSucceed

other functions

- testSetVotingPowerCap
- testSetVotingPowerCap_revertWhenLowerThanExisting
- testSetVotingPowerCap_revertWhenNonManagerCalled

testing the calculation of voting power token <-> burned token

Test the `calculateIncrementedVotingPower` function

- testCalculateIncrementedVotingPower
- testCalculateIncrementedVotingPower_0_to_10
- testCalculateIncrementedVotingPower_10_to_20
- testCalculateIncrementedVotingPower_20_to_30
- testCalculateIncrementedVotingPower_30_to_40
- testCalculateIncrementedVotingPower_40_to_50
- testCalculateIncrementedVotingPower_50_to_60
- testCalculateIncrementedVotingPower_60_to_70
- testCalculateIncrementedVotingPower_70_to_80
- testCalculateIncrementedVotingPower_80_to_90
- testCalculateIncrementedVotingPower_90_to_100
- testCalculateIncrementedVotingPower_100_to_110
- testCalculateIncrementedVotingPower_10_to_110
- testFuzzCalculateVotingPowerFromBurnedAmount
- testFuzzCalculateVotingPowerFromBurnedAmount_76750_92675
- testFuzzCalculateVotingPowerFromBurnedAmount_62325_76750
- testFuzzCalculateVotingPowerFromBurnedAmount_49400_62325
- testFuzzCalculateVotingPowerFromBurnedAmount_37975_49400
- testFuzzCalculateVotingPowerFromBurnedAmount_28050_37975
- testFuzzCalculateVotingPowerFromBurnedAmount_19625_28050
- testFuzzCalculateVotingPowerFromBurnedAmount_12700_19625
- testFuzzCalculateVotingPowerFromBurnedAmount_7275_12700
- testFuzzCalculateVotingPowerFromBurnedAmount_3350_7275
- testFuzzCalculateVotingPowerFromBurnedAmount_925_3350
- testFuzzCalculateVotingPowerFromBurnedAmount_0_925
- testFuzzCalculateIncrementedBurningAmount_0_to_110
- testFuzzCalculateIncrementedBurningAmount_10_to_110
- testFuzzCalculateIncrementedBurningAmount_20_to_110
- testFuzzCalculateIncrementedBurningAmount_30_to_110
- testFuzzCalculateIncrementedBurningAmount_40_to_110
- testFuzzCalculateIncrementedBurningAmount_50_to_110
- testFuzzCalculateIncrementedBurningAmount_60_to_110
- testFuzzCalculateIncrementedBurningAmount_70_to_110
- testFuzzCalculateIncrementedBurningAmount_80_to_110
- testFuzzCalculateIncrementedBurningAmount_90_to_110
- testFuzzCalculateIncrementedBurningAmount_100_to_110
- testFuzzCalculateBurningAmountFromVotingPower_0_110
- testFuzzCalculateBurningAmountFromVotingPower_100_110
- testFuzzCalculateBurningAmountFromVotingPower_90_100
- testFuzzCalculateBurningAmountFromVotingPower_80_90
- testFuzzCalculateBurningAmountFromVotingPower_70_80
- testFuzzCalculateBurningAmountFromVotingPower_60_70
- testFuzzCalculateBurningAmountFromVotingPower_50_60
- testFuzzCalculateBurningAmountFromVotingPower_40_50
- testFuzzCalculateBurningAmountFromVotingPower_30_40
- testFuzzCalculateBurningAmountFromVotingPower_20_30
- testFuzzCalculateBurningAmountFromVotingPower_10_20
- testFuzzCalculateBurningAmountFromVotingPower_0_10

Preparation internal functions

- calculateExpectedBurningAmount
- calculateExpectedVotingPower

## Coverage

| File                            | % Lines         | % Statements    | % Branches      | % Funcs         |
| ------------------------------- | --------------- | --------------- | --------------- | --------------- |
| src/AmbassadorNft.sol           | 100.00% (11/11) | 100.00% (13/13) | 100.00% (1/1)   | 100.00% (7/7)   |
| src/ERC20UpgradeableTokenV1.sol | 100.00% (18/18) | 100.00% (19/19) | 100.00% (1/1)   | 100.00% (8/8)   |
| src/GovToken.sol                | 100.00% (16/16) | 100.00% (20/20) | 100.00% (2/2)   | 100.00% (8/8)   |
| src/VotingPowerExchange.sol     | 100.00% (53/53) | 100.00% (80/80) | 100.00% (10/10) | 100.00% (12/12) |
| src/DaoGovernor.sol             | 100.00% (10/10) | 100.00% (19/19) | 100.00% (0/0)   | 100.00% (11/11) |

# Reference

## voting power calculation table

These are the values we used in the fuzz tests for voting power <-> burned token calculation.

- Function:

```
x = (2 \* sqrt(306.25 + 30y) - 5) / 30 - 1
y = (15*x^2+35*x)/2

x: mintedToken
y: burnedToken
```

- Table:

| Minted Token (lvl) | Level | Burned Token |
| ------------------ | ----- | ------------ |
| 0                  | 1     | 0            |
| 1                  | 2     | 25           |
| 2                  | 3     | 65           |
| 3                  | 4     | 120          |
| 4                  | 5     | 190          |
| 5                  | 6     | 275          |
| 6                  | 7     | 375          |
| 7                  | 8     | 490          |
| 8                  | 9     | 620          |
| 9                  | 10    | 765          |
| 10                 | 11    | 925          |
| 11                 | 12    | 1100         |
| 12                 | 13    | 1290         |
| 13                 | 14    | 1495         |
| 14                 | 15    | 1715         |
| 15                 | 16    | 1950         |
| 16                 | 17    | 2200         |
| 17                 | 18    | 2465         |
| 18                 | 19    | 2745         |
| 19                 | 20    | 3040         |
| 20                 | 21    | 3350         |
| 21                 | 22    | 3675         |
| 22                 | 23    | 4015         |
| 23                 | 24    | 4370         |
| 24                 | 25    | 4740         |
| 25                 | 26    | 5125         |
| 26                 | 27    | 5525         |
| 27                 | 28    | 5940         |
| 28                 | 29    | 6370         |
| 29                 | 30    | 6815         |
| 30                 | 31    | 7275         |
| 31                 | 32    | 7750         |
| 32                 | 33    | 8240         |
| 33                 | 34    | 8745         |
| 34                 | 35    | 9265         |
| 35                 | 36    | 9800         |
| 36                 | 37    | 10350        |
| 37                 | 38    | 10915        |
| 38                 | 39    | 11495        |
| 39                 | 40    | 12090        |
| 40                 | 41    | 12700        |
| 41                 | 42    | 13325        |
| 42                 | 43    | 13965        |
| 43                 | 44    | 14620        |
| 44                 | 45    | 15290        |
| 45                 | 46    | 15975        |
| 46                 | 47    | 16675        |
| 47                 | 48    | 17390        |
| 48                 | 49    | 18120        |
| 49                 | 50    | 18865        |
| 50                 | 51    | 19625        |
| 51                 | 52    | 20400        |
| 52                 | 53    | 21190        |
| 53                 | 54    | 21995        |
| 54                 | 55    | 22815        |
| 55                 | 56    | 23650        |
| 56                 | 57    | 24500        |
| 57                 | 58    | 25365        |
| 58                 | 59    | 26245        |
| 59                 | 60    | 27140        |
| 60                 | 61    | 28050        |
| 61                 | 62    | 28975        |
| 62                 | 63    | 29915        |
| 63                 | 64    | 30870        |
| 64                 | 65    | 31840        |
| 65                 | 66    | 32825        |
| 66                 | 67    | 33825        |
| 67                 | 68    | 34840        |
| 68                 | 69    | 35870        |
| 69                 | 70    | 36915        |
| 70                 | 71    | 37975        |
| 71                 | 72    | 39050        |
| 72                 | 73    | 40140        |
| 73                 | 74    | 41245        |
| 74                 | 75    | 42365        |
| 75                 | 76    | 43500        |
| 76                 | 77    | 44650        |
| 77                 | 78    | 45815        |
| 78                 | 79    | 46995        |
| 79                 | 80    | 48190        |
| 80                 | 81    | 49400        |
| 81                 | 82    | 50625        |
| 82                 | 83    | 51865        |
| 83                 | 84    | 53120        |
| 84                 | 85    | 54390        |
| 85                 | 86    | 55675        |
| 86                 | 87    | 56975        |
| 87                 | 88    | 58290        |
| 88                 | 89    | 59620        |
| 89                 | 90    | 60965        |
| 90                 | 91    | 62325        |
| 91                 | 92    | 63700        |
| 92                 | 93    | 65090        |
| 93                 | 94    | 66495        |
| 94                 | 95    | 67915        |
| 95                 | 96    | 69350        |
| 96                 | 97    | 70800        |
| 97                 | 98    | 72265        |
| 98                 | 99    | 73745        |
| 99                 | 100   | 75240        |
| 100                | 101   | 76750        |
| 101                | 102   | 78275        |
| 102                | 103   | 79815        |
| 103                | 104   | 81370        |
| 104                | 105   | 82940        |
| 105                | 106   | 84525        |
| 106                | 107   | 86125        |
| 107                | 108   | 87740        |
| 108                | 109   | 89370        |
| 109                | 110   | 91015        |
| 110                | 111   | 92675        |

....

## JavaScript code for testing the activity in Web2

Start the repository by running:

```
npm init -y
npm install bigint-isqrt
```

Copy the following code to the `index.js` and `calculator.js` file and run:

```
node index.js
```

### JS code used for testing

- `index.js`

```javascript
const {
  calculateVotingPowerFromBurnedAmount,
  calculateIncrementedVotingPower,
  calculateIncrementedBurningAmount,
  calculateBurningAmountFromVotingPower,
} = require("./calculator");

function main() {
  ////////////////////////////////////////////////////////////////////////////
  // =========== testing calculateVotingPowerFromBurnedAmount ============= //
  ////////////////////////////////////////////////////////////////////////////
  const incrementedAmount = 3340n * BigInt(1e18); // Increase by 3,340 tokens
  const currentBurnedAmount = 0n * BigInt(1e18); // Currently burned 0 tokens
  const increasedVotingPower = calculateIncrementedVotingPower(
    incrementedAmount,
    currentBurnedAmount
  );
  console.log(`Increased voting power: ${increasedVotingPower}`);
  // Actual result: 19968480468933333333

  const incrementedAmount2 = 3340n * BigInt(1e18); // Increase by 3,340 tokens
  const currentBurnedAmount2 = 30n * BigInt(1e18); // Currently burned 30 tokens
  const increasedVotingPower2 = calculateIncrementedVotingPower(
    incrementedAmount2,
    currentBurnedAmount2
  );
  console.log(`Increased voting power 2: ${increasedVotingPower2}`);
  // Actual result: 18914158006533333334

  const incrementedAmount3 = 19600n * BigInt(1e18); // Increase by 19,600 tokens
  const currentBurnedAmount3 = 50n * BigInt(1e18); // Currently burned 50 tokens
  const increasedVotingPower3 = calculateIncrementedVotingPower(
    incrementedAmount3,
    currentBurnedAmount3
  );
  console.log(`Increased voting power 3: ${increasedVotingPower3}`);
  // Actual result: 48365896261533333334

  const incrementedAmount4 = 765n * BigInt(1e18); // Increase by 765 tokens
  const currentBurnedAmount4 = 370n * BigInt(1e18); // Currently burned 370 tokens
  const increasedVotingPower4 = calculateIncrementedVotingPower(
    incrementedAmount4,
    currentBurnedAmount4
  );
  console.log(`Increased voting power 4: ${increasedVotingPower4}`);
  // Actual result: 5236956231600000000

  const incrementedAmount5 = 15000n * BigInt(1e18); // Increase by 15,000 tokens
  const currentBurnedAmount5 = 1000n * BigInt(1e18); // Currently burned 1,000 tokens
  const increasedVotingPower5 = calculateIncrementedVotingPower(
    incrementedAmount5,
    currentBurnedAmount5
  );
  console.log(`Increased voting power 5: ${increasedVotingPower5}`);
  // Actual result: 34596960073333333334

  const incrementedAmount6 = 9260n * BigInt(1e18); // Increase by 9,260 tokens
  const currentBurnedAmount6 = 4000n * BigInt(1e18); // Currently burned 4,000 tokens
  const increasedVotingPower6 = calculateIncrementedVotingPower(
    incrementedAmount6,
    currentBurnedAmount6
  );
  console.log(`Increased voting power 6: ${increasedVotingPower6}`);
  // Actual result: 18940313422933333334

  ////////////////////////////////////////////////////////////////////////////
  // =========== testing calculateBurningAmountFromVotingPower ============ //
  ////////////////////////////////////////////////////////////////////////////
  const votingPowerAmount = 20n * BigInt(1e18); // 20 voting power
  const burningAmount =
    calculateBurningAmountFromVotingPower(votingPowerAmount);
  console.log(
    `Burning amount (${votingPowerAmount / BigInt(1e18)} voting power): ${
      burningAmount / BigInt(1e18)
    }`
  );
  // Actual result: 3350

  const incrementedVotingPower = 5n * BigInt(1e18); // Increase by 5 voting power
  const currentVotingPower = 15n * BigInt(1e18); // Current 15 voting power
  const incrementedBurningAmount = calculateIncrementedBurningAmount(
    incrementedVotingPower,
    currentVotingPower
  );
  console.log(`Increased burning amount: ${incrementedBurningAmount}`);
  // Actual result: 1400000000000000000000

  const incrementedVotingPower1 = 99n * BigInt(1e17);
  const currentVotingPower1 = 0n * BigInt(1e17);
  const incrementedBurningAmount1 = calculateIncrementedBurningAmount(
    incrementedVotingPower1,
    currentVotingPower1
  );
  console.log(`Increased burning amount 1: ${incrementedBurningAmount1}`);
  // Actual result: 908325000000000000000

  const incrementedVotingPower2 = 10n * BigInt(1e18);
  const currentVotingPower2 = 0n * BigInt(1e18);
  const incrementedBurningAmount2 = calculateIncrementedBurningAmount(
    incrementedVotingPower2,
    currentVotingPower2
  );
  console.log(`Increased burning amount 2: ${incrementedBurningAmount2}`);
  // Actual result: 925000000000000000000

  const incrementedVotingPower3 = 1n * BigInt(1e18);
  const currentVotingPower3 = 49n * BigInt(1e18);
  const incrementedBurningAmount3 = calculateIncrementedBurningAmount(
    incrementedVotingPower3,
    currentVotingPower3
  );
  console.log(`Increased burning amount 3: ${incrementedBurningAmount3}`);
  // Actual result: 1715000000000000000000

  const incrementedVotingPower4 = 101n * BigInt(1e17);
  const currentVotingPower4 = 3022n * BigInt(1e16);
  const incrementedBurningAmount4 = calculateIncrementedBurningAmount(
    incrementedVotingPower4,
    currentVotingPower4
  );
  console.log(`Increased burning amount 4: ${incrementedBurningAmount4}`);
  // Actual result: 5520155000000000000000

  const incrementedVotingPower5 = 151n * BigInt(1e17);
  const currentVotingPower5 = 2522n * BigInt(1e16);
  const incrementedBurningAmount5 = calculateIncrementedBurningAmount(
    incrementedVotingPower5,
    currentVotingPower5
  );
  console.log(`Increased burning amount 5: ${incrementedBurningAmount5}`);
  // Actual result: 7686655000000000000000
}

main();
```

- `calculator.js`

```javascript
const sqrt = require("bigint-isqrt");

const PRECISION = BigInt(1e18);
const PRECISION_FIX = BigInt(1e9);

function calculateVotingPowerFromBurnedAmount(amount) {
  // 将输入转换为 BigInt
  amount = BigInt(amount);

  // 计算 306.25 + 30*x
  const innerValue = BigInt(30625) * BigInt(1e16) + BigInt(30) * amount;

  // 计算 2*SQRT(306.25 + 30*x)
  const sqrtPart = BigInt(2) * sqrt(innerValue) * PRECISION_FIX;

  // 计算 (2*SQRT(306.25+30*x)-5)/30 - 1
  const result = (sqrtPart - BigInt(5) * PRECISION) / BigInt(30) - PRECISION;

  return result;
}

function calculateIncrementedVotingPower(
  incrementedAmount,
  currentBurnedAmount
) {
  const newTotal = calculateVotingPowerFromBurnedAmount(
    BigInt(incrementedAmount) + BigInt(currentBurnedAmount)
  );
  const current = calculateVotingPowerFromBurnedAmount(currentBurnedAmount);
  return newTotal - current;
}

function calculateIncrementedBurningAmount(
  incrementedVotingPower,
  currentVotingPower
) {
  const newTotal = calculateBurningAmountFromVotingPower(
    BigInt(currentVotingPower) + BigInt(incrementedVotingPower)
  );
  const current = calculateBurningAmountFromVotingPower(currentVotingPower);
  return newTotal - current;
}

function calculateBurningAmountFromVotingPower(votingPowerAmount) {
  // 将输入转换为 BigInt
  votingPowerAmount = BigInt(votingPowerAmount);

  // 计算 y = (15*x^2+35*x)/2
  const term =
    (BigInt(15) * votingPowerAmount * votingPowerAmount) / PRECISION +
    BigInt(35) * votingPowerAmount;
  const result = term / BigInt(2);

  return result;
}

module.exports = {
  calculateVotingPowerFromBurnedAmount,
  calculateIncrementedVotingPower,
  calculateIncrementedBurningAmount,
  calculateBurningAmountFromVotingPower,
};
```
